{% extends 'base.html' %}
{% load static %}
{% load form_filters %}

{% block content %}
<div class="row">
  <div class="col-lg-8 mb-4">
    <div class="card shadow-sm mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Feedback Details</h5>
        <span class="badge bg-primary">{{ feedback.issue_type|title }}</span>
      </div>
      <div class="card-body">
        <p class="mb-1"><strong>Road:</strong> {{ feedback.road_name }}</p>
        <p class="mb-1"><strong>Location:</strong> {{ feedback.location }} ({{ feedback.city }}, {{ feedback.state }})</p>
        <p class="mb-1"><strong>Condition:</strong> {{ feedback.get_condition_display }}</p>
        <p class="mb-3"><strong>Description:</strong><br>{{ feedback.description }}</p>
        {% if feedback.image %}
          <div class="feedback-image-wrapper mb-3">
            <a href="#" data-bs-toggle="modal" data-bs-target="#imageModal">
              <img src="{{ feedback.image.url }}" alt="Road image" class="img-fluid rounded shadow-sm" style="max-height:200px;object-fit:cover;">
            </a>
            <small class="text-muted d-block mt-1">Click image to enlarge</small>
          </div>
        {% endif %}
        <small class="text-muted">Submitted by {{ feedback.user.username }} on {{ feedback.created_at|date:'M d, Y H:i' }}</small>
      </div>
    </div>

    <div class="card shadow-sm">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="mb-0">Comments</h6>
        <span class="badge bg-light text-dark">{{ comments|length }} total</span>
      </div>
      <div class="card-body">
        {% if comments %}
          <ul class="list-unstyled mb-4">
            {% for c in comments %}
            <li class="comment-item mb-3 p-3 rounded" style="background:rgba(13,110,253,0.04);">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <strong>{{ c.user.username }}</strong>
                  <small class="text-muted ms-2">{{ c.created_at|date:'M d, Y H:i' }}</small>
                </div>
              </div>
              <p class="mb-0 mt-2">{{ c.text }}</p>
            </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="text-muted">No comments yet. Be the first to comment.</p>
        {% endif %}

        <hr>
        <h6 class="mb-2">Add a Comment</h6>
        <form method="post" novalidate class="comment-form">
          {% csrf_token %}
          {{ comment_form.non_field_errors }}
          <div class="mb-3">
            {{ comment_form.text.errors }}
            {{ comment_form.text }}
          </div>
          <button type="submit" class="btn btn-primary">Post Comment</button>
          <a href="{% url 'reports:feedback_analysis' %}" class="btn btn-outline-secondary ms-2">Back to Analysis</a>
        </form>
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card shadow-sm mb-4">
      <div class="card-header"><h6 class="mb-0">Map Location</h6></div>
      <div class="card-body">
        <div id="map" style="height:300px;"></div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script async defer src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}"></script>
<script>
(function(){
  const lat = parseFloat('{{ feedback.latitude }}');
  const lng = parseFloat('{{ feedback.longitude }}');
  function initDetailMap(){
    if(!window.google) return; 
    const map = new google.maps.Map(document.getElementById('map'), {
      center: {lat: lat, lng: lng},
      zoom: 15,
      mapTypeId: 'roadmap'
    });
    new google.maps.Marker({position:{lat:lat,lng:lng}, map: map});
  }
  window.initDetailMap = initDetailMap;
  setTimeout(initDetailMap, 300);
})();
</script>
<!-- Image modal -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header" style="background:linear-gradient(90deg,#FF9933,#ffffff,#138808);">
        <h5 class="modal-title">Road Image</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-0">
        {% if feedback.image %}
          <img src="{{ feedback.image.url }}" alt="Full road image" class="w-100" style="max-height:70vh;object-fit:contain;background:#000;">
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}
